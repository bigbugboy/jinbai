{% extends 'base.html' %}
{% load static %}

{% block css %}

<style>
    [v-cloak] {
        display: none;
    }

    .box {
        background-color: transparent !important;
        color: rgb(25, 132, 52) !important;
        box-shadow: 0 1.5em 2em 0.875em rgba(10, 10, 10, .1), 0 0 0 2px rgba(10, 10, 10, .02);
    }

    #sc-info {
        padding-bottom: 4px;
        border-bottom: 4px solid rgb(25, 132, 52);
    }

    .title_block {
        font-size: 20px;
        font-weight: bolder;
        padding: 10px;
        padding-left: 0px;
        margin-top: 20px;
    }

    /* 修复bulma导致co代码块高亮冲突 */
    .token.number {
        background-color: transparent !important;
        border-radius: 0px !important;
        display: inline !important;
        padding: 0px !important;
    }

    code[class*=language-],
    pre[class*=language-] {
        font-size: 16px !important;
    }

    .choice_block {
        font-size: 20px;
        padding: 10px;
        border: 1px solid rgb(25, 132, 52);
        border-radius: 10px;
        cursor: pointer;
        box-shadow: 0 1.5em 2em 0.875em rgba(10, 10, 10, .1), 0 0 0 2px rgba(10, 10, 10, .02);
        transition: all .3s ease;
        position: relative;
    }

    .choice {
        position: absolute;
        top: 0px;
        left: 0px;
        width: 50px;
        height: 100%;
        padding: 10px;
        background-color: rgb(254, 223, 144);
        border-bottom-left-radius: 10px;
        border-top-left-radius: 10px;
        display: grid;
        place-items: center;
        /* 水平和垂直居中 */
        font-size: 20px;
    }

    .choice-detail {
        margin-left: 50px;
    }

    .choice_block:hover {
        box-shadow: none;
    }

    .choice_block.selected {
        background-color: rgb(254, 223, 144);
    }

    .choice_block.success {
        color: #000;
        background-color: rgb(25, 132, 52);
        opacity: 0.8;
    }

    .choice_block.failed {
        color: #000;
        background-color: red;
        opacity: 0.8;
    }

    .choice_block.selected .choice,
    .choice_block.success .choice,
    .choice_block.failed .choice {
        border-right: 1px solid rgb(25, 132, 52);
    }

    #confirmbtn {
        font-size: 20px;
        font-weight: bolder;
        color: #000;
    }

    #confirmbtn:hover {
        background-color: rgb(25, 132, 52);
    }

    .answer,
    .description {
        font-size: 20px;
        line-height: 35px;
        margin: 10px;
    }
</style>
<link rel="stylesheet" href="{% static 'prism/prism.css' %}">

{% endblock %}


{% block content %}
{% include 'partials/header.html' %}
{% include 'partials/sweetalert.html' %}
<div class="box mt-6" id="app" v-cloak>
    <p id="sc-info">
        <span class="mr-5"><small class="mr-2">题号:</small><strong v-text="sc.no"></strong></span>
        <span class="mr-5"><small class="mr-2">标签:</small><strong v-text="sc.tag"></strong></span>
        <span><small class="mr-2">难度:</small><strong>{[sc.star]}颗星</strong></span>
    </p>
    <div class="block title_block" v-html="sc.title"></div>
    <div class="block choice_block" v-for="(item, index) in 'abcd'" @click="selectOne(index)" :key="index"
        :choice="item" ref="choiceBlocks">
        <div class="choice" v-text="item.toUpperCase()"></div>
        <div class="choice-detail" v-html="sc[`choice_${item}`]"></div>
    </div>

    <div class="buttons is-centered mt-6">
        <button class="button is-rounded is-success is-outlined" :disabled="left_sc_counts < 1" id="confirmbtn"
            @click="postQuestion">
            <span v-if="left_sc_counts !== 0">确认&解析</span>
            <span v-else>今日答题次数已用完</span>
        </button>
        <span>{[left_sc_counts]}/{[daily_sc_counts]}</span>
    </div>
    <div v-if="right_choice" class="block">
        <div v-if="right_choice" class="answer">答案: <strong v-text="right_choice.toUpperCase()"></strong></div>
        <div v-if="description" class="description">解析: <small v-html="description"></small></div>
        <p class="description">
            <button class="button is-warning" :disabled="left_sc_counts === 1" @click="getOneQuestion">下一题</button>
        </p>
    </div>
</div>

{%endblock%}


{% block js %}
<script src="{% static 'js/common.js' %}"></script>
<script src="{% static 'ckeditor/ckeditor/plugins/prism/lib/prism/prism_patched.min.js' %}"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.12/vue.js"></script>
<script>
    var app = new Vue({
        el: '#app',
        delimiters: ["{[", "]}"],
        data: function () {
            return {
                sc: {
                    tags: []
                },
                selected_block: null,
                right_choice: '',
                description: '',
                daily_sc_counts: 0,
                left_sc_counts: 0,
            }
        },
        methods: {
            getOneQuestion: function () {
                fetch("{% url 'scstart' %}").then((res) => {
                    if (!res.ok) {
                        alert('今日答题次数已用完')
                        throw new Error()

                    } else {
                        return res.json()
                    }
                }).then((data) => {
                    this.resetInfo();
                    this.sc = data;
                    this.daily_sc_counts = data['daily_sc_counts'];
                    this.left_sc_counts = data['left_sc_counts'];

                })
            },
            postQuestion: function () {
                if (!this.selected_block) {
                    sweetAlert('info', '请先选择一个选项！')
                    return;
                }
                if (this.right_choice) {
                    return;
                }
                fetch("{% url 'scstart' %}", {
                    method: 'POST',
                    headers: {
                        Accept: 'application.json',
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'todo-sc-no': this.sc.no,
                        'select-choice': this.selected_block.getAttribute('choice'),
                    }
                }).then((res) => res.json()).then((data) => {
                    this.right_choice = data.right_choice;
                    this.description = data.desc;
                    this.selected_block.classList.remove('selected');
                    if (this.left_sc_counts === 1) {
                        this.left_sc_counts = 0
                        sweetAlert('info', '今日答题次数已用完')
                    }

                    if (data.status === true) {
                        this.selected_block.classList.add('success');
                    } else {
                        this.selected_block.classList.add('failed');
                    }
                })
            },
            selectOne: function (index) {
                // 获取外层的choice_block
                const block = this.$refs.choiceBlocks[index];
                if (!block.classList.contains('choice_block')) {
                    block = block.parentNode
                }
                // 二次点击取消选中状态
                if (block.classList.contains('selected')) {
                    block.classList.remove('selected')
                    return
                }
                // 点击并选中其他block
                choises = document.getElementsByClassName('choice_block')
                for (let index = 0; index < choises.length; index++) {
                    choises[index].classList.remove('selected')
                }
                block.classList.add('selected')
                this.selected_block = block;
            },
            resetInfo: function () {
                this.sc = { tags: [] }
                this.selected_block = null
                this.right_choice = ''
                this.description = ''
                choises = document.getElementsByClassName('choice_block')
                for (let index = 0; index < choises.length; index++) {
                    choises[index].classList.remove('selected')
                    choises[index].classList.remove('success')
                    choises[index].classList.remove('failed')
                }
            },
        },
        mounted() {
            this.getOneQuestion()
            // Vue实例渲染完成后执行的逻辑
            document.getElementById('app').style.display = 'block';
        },
        updated() {
            //保证v-html渲染的代码块高亮显示
            Prism.highlightAll();
        },
    })
</script>
{% endblock %}